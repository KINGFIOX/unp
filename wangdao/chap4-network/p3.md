# chap4 - 网络层 - IP 数据报格式

## TCP/IP 协议栈

![](image/2024-02-25-12-23-13.png)

## IP 数据报格式

（先暂时把 分组 和 数据报 当成同一种东西）

IP：首部（固定部分+可变部分） + 数据部分（TCP、UDP 段）

![](image/2024-02-25-12-24-39.png)

- 版本(有 4 位) ： IPv4 or IPv6 ？
- 首部长度(有 4 位)：(0~15) x 4B，但是我们固定部分是 20B，因此：(5~15) x 4B
- 区分服务(有 8 位)：指明 期望获得哪种类型的服务。如果不启用服务的话，可以空这
- 总长度(有 16 位)：整个数据报的长度，也就是 IP 数据报的长度为：(20~65535) x 1B。然而一般不会达到 65535，因为要满足 链路层的 MTU

- 标识（16bit）
- 标志（4bit）
- 片偏移（16bit）

- 生存时间（TTL, time to live）（8bit）：IP 分组的保质期。经过一个路由器 -1，变成 0 则丢弃。防止数据报死循环
- 协议（8bit）数据部分的协议
- 首部检验和（16bit）：只检验首部。看首部是否要出错

![协议](image/2024-02-25-12-33-50.png)

- src 地址（32bit）
- dest 地址（32bit）

- 可选字段（长度可变）+ 填充（要求首部是 4B 的整数倍，因为首部长度是 x4B 的）

## 最大传送单元 MTU

MTU：链路层数据帧可封装数据的上限。
以太网的 MTU 是 1500 B。

如果 `IP分组` 超过了 链路的 MTU ，怎么办？ 对 `IP分组` 分片。
如果 `IP分组` 就是不想让你分片呢？那么 `IP分组` 就不能继续向下传递了，
因此就会传输一个 SMP 的出错报文。

## IP 数据报分片

标识：同一数据报的分片使用 同一标识

- 标志（4bit）：只有 2 位有意义，也就是只有 2 位有用。

  - 第一位 DF（dont't fragment）
    - DF=1，禁止分片
    - DF=0，允许分片
  - 第二位 MF（more fragment）
    - MF=1，后面 “还有分片”
    - MF=0，代表最后一片/没分片了

- 片偏移：指出较长分组 分片后，某片在原分组中的相对位置。以 8B 为单位
  表示：除了最后一个分片，每个分片的长度一定是 8B 的整数倍

小结：IP 数据报格式：

- 总长度单位是 1B
- 片偏移单位是 8B
- 首部长度单位是 4B

### 例题

![](image/2024-02-25-14-39-01.png)

## IP 编织的历史阶段

分类的 IP 地址、子网的划分、构成超网（无分类编址方法）

## 分类的 IP 地址

比方说：123456_12345678_1234 这串身份证号

IP 地址：全世界唯一的 32bit/4B 标识符，标识路由器主机的接口（可以有 有线接口、无线接口）。
路由器，一个接口就是一个 IP 地址

`IP地址 ::= {<网络号> <主机号>}`

![](image/2024-02-25-14-54-53.png)

有一种网络叫做：无编号网络。上面这个网络，逻辑上有 6 个网络组成

![](image/2024-02-25-14-58-16.png)

D 类地址是 多播地址，是在 一对多 通信的时候才会使用

## 特殊 IP 地址

![](image/2024-02-25-15-02-46.png)

有点抽象

## 私有 IP 地址

![](image/2024-02-25-15-03-30.png)

会涉及到 NAT 技术

## 分类的 IP 地址

- A 类：
  可用网络号：0000 不能用，127 不能用。剩下 7 个位，那么可以使用的网络号就是：`2^7 - 2`。
  可用主机号：全 0 不可用，全 1 也不可用（广播）
- B 类：
  可用网络号：`128.0`是不可用的，然后剩下有 14bit。那么可以额使用的网络号就是：`2^14 - 1`。
- C 类：（同理）

![](image/2024-02-25-15-10-21.png)

## 网络地址转换（NAT）

路由器对 目的地址 是 私有 IP 地址的 数据报一律不进行转发。

网络地址转换（network address translation）：在专用网连接到因特网的路由器上安装 NAT 软件，
安装了 NAT 软件的路由器叫 NAT 路由器，他至少有一个有效的外部全球 IP 地址。

端口号是一个：传输层的概念

![](image/2024-02-25-15-15-33.png)

## 子网划分

分类的 IP 地址的弱点：

1. IP 地址的利用率有时很低
2. 两级 IP 地址不够灵活

- 两级 IP 地址：`{网络号, 主机号}`
- 三级 IP 地址：`{网络号, 子网号, 主机号}`

某单位划分子网后，对外仍表现为一个网络，即 本单位外的网络看不见本单位内子网的划分。至少留两位给主机号

## 子网掩码

![](image/2024-02-25-15-22-49.png)

子网掩码 与 IP 地址相与，就得到了 子网网络地址

### 子网掩码例题

![](image/2024-02-25-15-27-31.png)

![](image/2024-02-25-15-30-55.png)

## 使用子网时 分组的转发

路由表中：

1. 目的网络地址
2. 目的网络子网掩码
3. 下一跳地址

路由器转发分组的算法：

1. 提取目的 IP 地址
2. 是否直接交付
3. 特定主机路由
4. 检测路由表中 有无路径
5. 默认路由 0.0.0.0 ---> 下一个路由器
6. 丢弃，报告转发分组出错（数据报有 TTL）

## 无分类编址 CIDR

背景：1992 年 B 类地址很快将分配网。路由表中的项目急剧增长

CIDR 采用了，`IP = {网络前缀, 主机号}` 的形式

沿用了：子网掩码的概念

![](image/2024-02-25-15-41-23.png)
